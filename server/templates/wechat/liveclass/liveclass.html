{% extends "wechat/wechat_base_simple.html" %}

{% block title %}{{ live_class.lecturer_name }} 在麻辣老师为您讲课{% endblock %}
{% load staticfiles %}
{% load compile_static %}
{% load custom_tags %}

{% block addition_header %}
  <link rel="stylesheet" href="{% static 'common/css/bootstrap.min.css' %}">
  <link rel="stylesheet" href="{% static 'wechat/css/wechat_base.less'|compile %}">
  <link rel="stylesheet" href="{% static 'wechat/css/liveclass.less'|compile %}">
{% endblock %}

{% block content %}
  <div class="page" id="liveclasses">
  {#下载横条#}
    {% include 'wechat/w_download_banner.html' %}
    <div class="content">
      <div class="card">
        <h3>{{ live_class.course_name }}</h3>
        <div class="horizontal"></div>
        <div class="grade">
          <div class="tag">
            <span>{{ live_class.room_capacity }}人小班</span>
            <span>{{ live_class.course_grade }}</span>
          </div>
          <p><span class="glyphicon glyphicon-time"></span>{{ course_start }}-{{ course_end }}</p>
          {% for course_period in course_periods %}
            <p class="period">{{ course_period }}</p>
          {% endfor %}
          <p><span class="glyphicon glyphicon-bell"></span>剩余名额:
            <strong>{{ seats_remaining }}人</strong>
          </p>
          <p><span class="glyphicon glyphicon-map-marker"></span>{{ live_class.school_name }}</p>
          <p class="address">{{ live_class.school_address }}</p>
        </div>
      </div>
      <div class="card">
        <h3>课程介绍</h3>
        <div class="horizontal"></div>
        <div class="lesson">
          {% for course_description in course_descriptions %}
            <p>{{ course_description }}</p>
          {% endfor %}
        </div>
      </div>
      <div class="card">
        <h3>直播名师</h3>
        <div class="horizontal"></div>
        <div class="teacher">
          <img src="https://b-ssl.duitang.com/uploads/item/201604/10/20160410150542_AJUcX.thumb.700_0.jpeg" alt="直播名师">
          <div>{{ live_class.lecturer_name }}</div>
          {% for lecturer_bio in lecturer_bios %}
            <p>{{ lecturer_bio }}</p>
          {% endfor %}
        </div>
      </div>
      <div class="card">
        <h3>联系助教</h3>
        <div class="horizontal"></div>
        <div class="tutor">
          <a href="tel:{{ live_class.assistant_phone }}"><img src="http://img.zcool.cn/community/01fcab579c23060000018c1bca35d7.png" alt="点此拨打电话"></a>
          <p>助教: {{ live_class.assistant_name }}</p>
          <p>对课程有疑问? 快电话咨询助教老师吧!</p>
        </div>
      </div>
    </div>
    <div class="bottom">
      <p>￥{{ live_class.course_fee|money_format:'/' }} /
        <span>{{ live_class.course_lessons }}次</span>
      </p>
      <a href="#" class="right" id="confirmBtn">立即购买</a>
      <input type="hidden" name="liveClassId" id="liveClassId"
             value="{{ live_class.id }}"/>
    </div>
  </div>
{% endblock %}

{% block addition_js %}
  <script type='text/javascript' src='//res.wx.qq.com/open/js/jweixin-1.0.0.js'
          charset='utf-8'></script>
  <script>
    var order_pay_url = '{% url 'wechat:order-course-choosing' %}';
    wx.config({
      debug: false,
      appId: '{{ WX_APPID }}',
      timestamp: '{{ timestamp }}',
      nonceStr: '{{ noncestr }}',
      signature: '{{ signature }}',
      jsApiList: ['chooseWXPay', 'getLocation', 'closeWindow']
    });

    var liveClassId = $('#liveClassId').val();
    var isPaying = false;
    var $payBtn = $('#confirmBtn');

    var beginPaying = function() {
      isPaying = true;
    };
    var stopPaying = function() {
      hideLoading();
    };

    $payBtn.click(function(e) {
      e.preventDefault();

      if (isPaying) {
        return;
      }
      beginPaying();
      var params = {
        'action': 'confirm',
        'live_class': liveClassId,
        'coupon': ''
      };
      var defaultErrMsg = '请求失败, 请稍后重试或联系客户人员!';
      $.ajax({
        'type': "POST",
        'url': order_pay_url,
        'data': params,
        'success': function(result) {
          if (result) {
            if (result.ok) {
              var data = result.data;
              var prepay_id = data.prepay_id;
              var order_id = data.order_id;
              if (data.TESTING) {
                // in TESTING
                var verify_params = {
                  'action': 'verify',
                  'prepay_id': prepay_id,
                  'order_id': order_id
                };
                $.ajax({
                  'type': "POST",
                  'url': location.pathname,
                  'data': verify_params,
                  'success': function(verify_ret) {
                    if (verify_ret && verify_ret.ok) {
                      alert('支付成功');
                    } else {
                      alert(verify_ret && verify_ret.msg || defaultErrMsg);
                    }
                    stopPaying();
                  },
                  'dataType': 'json',
                  'error': function() {
                    alert('获取支付结果失败');
                    stopPaying();
                  }
                });
                return;
              }
              wx.chooseWXPay({
                timestamp: data.timeStamp, // 支付签名时间戳，注意微信jssdk中的所有使用timestamp字段均为小写。但最新版的支付后台生成签名使用的timeStamp字段名需大写其中的S字符
                nonceStr: data.nonceStr, // 支付签名随机串，不长于 32 位
                package: data.package, // 统一支付接口返回的prepay_id参数值，提交格式如：prepay_id=***）
                signType: data.signType, // 签名方式，默认为'SHA1'，使用新版支付需传入'MD5'
                paySign: data.paySign, // 支付签名
                success: function(res) {
                  var verify_params = {
                    'action': 'verify',
                    'prepay_id': prepay_id,
                    'order_id': order_id
                  };
                  $.ajax({
                    'type': "POST",
                    'url': location.pathname,
                    'data': verify_params,
                    'success': function(verify_ret) {
                      if (verify_ret && verify_ret.ok) {
                        wx.closeWindow();
                        return;
                      } else {
                        alert(verify_ret && verify_ret.msg || defaultErrMsg);
                      }
                      stopPaying();
                    },
                    'dataType': 'json',
                    'error': function() {
                      alert('获取支付结果失败');
                      stopPaying();
                    }
                  });
                },
                fail: function(res) {
                  $.ajax({ // 取消订单
                    'type': "DELETE",
                    'url': data.orders_api_url,
                    'success': function() {
                      stopPaying();
                    },
                    'error': function() {
                      stopPaying();
                    }
                  });
                },
                //complete: function(){
                //    stopPaying();
                //},
                cancel: function() {
                  $.ajax({ // 取消订单
                    'type': "DELETE",
                    'url': data.orders_api_url,
                    'success': function() {
                      stopPaying();
                    },
                    'error': function() {
                      stopPaying();
                    }
                  });
                }
              });
            } else {
              alert(result.msg);
              stopPaying();
            }
          } else {
            alert(defaultErrMsg);
            stopPaying();
          }
        },
        'dataType': 'json',
        'error': function() {
          alert(defaultErrMsg);
          stopPaying();
        }
      });
      e.stopPropagation();
    });
  </script>
{% endblock %}
